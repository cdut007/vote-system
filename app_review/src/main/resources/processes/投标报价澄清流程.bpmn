<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/test">
  <process id="bid_file_price_clarify_flow" name="报价澄清流程" isExecutable="true">
    <userTask id="usertask19" name="报价澄清签字" activiti:assignee="${userId}" activiti:formKey="clarification/bidfile_clarifi_sign">
      <documentation>${projectInstanceName} ${projectItemName} 报价澄清签字</documentation>
      <extensionElements>
        	<activiti:formProperty id="projectItemId" name="标段ID" type="string" expression="${projectItemId}"></activiti:formProperty>
        	<activiti:formProperty id="bidFileId" name="投标报价ID" type="string" expression="${bidFileId}"></activiti:formProperty>
       		<activiti:formProperty id="tenderItemId" name="tenderItemId" type="string" expression="${tenderItemId}"></activiti:formProperty>
      </extensionElements>
      <multiInstanceLoopCharacteristics isSequential="false" activiti:collection="${expertIds}" activiti:elementVariable="userId"></multiInstanceLoopCharacteristics>
    </userTask>
    <startEvent id="startevent11" name="等待开标"></startEvent>
    <scriptTask id="scripttask1" name="变量初始化" scriptFormat="groovy" activiti:autoStoreVariables="false">
      <script>
      		def expertApplyId=execution.getVariable("expertApplyId");
      		def expertIds=execution.getVariable("expertIds");
      		def projectItemId=execution.getVariable("projectItemId");      		
      </script>
    </scriptTask>
    <sequenceFlow id="flow238" sourceRef="startevent11" targetRef="scripttask1"></sequenceFlow>
    <endEvent id="endevent21" name="End"></endEvent>
    <sequenceFlow id="flow243" sourceRef="usertask19" targetRef="scripttask2">
      <extensionElements>
        <activiti:executionListener event="take" expression="${bidFileService.confirmRevisePrice(expertApplyId,projectItemId)}"></activiti:executionListener>
      </extensionElements>
    </sequenceFlow>
    <sequenceFlow id="flow244" sourceRef="scripttask1" targetRef="usertask20"></sequenceFlow>
    <userTask id="usertask20" name="报价澄清" activiti:assignee="${tenderUserId}" activiti:formKey="clarification/bidfile_clarifi">
      <documentation>${projectInstanceName} ${projectItemName} 投标报价澄清</documentation>
      <extensionElements>
        <activiti:formProperty id="projectItemId" name="标段ID" type="string" expression="${projectItemId}"></activiti:formProperty>
        <activiti:formProperty id="bidFileId" name="投标报价ID" type="string" expression="${bidFileId}"></activiti:formProperty>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow245" sourceRef="usertask20" targetRef="usertask21"></sequenceFlow>
    <scriptTask id="scripttask2" name="结果检查" scriptFormat="groovy" activiti:autoStoreVariables="false">
   	 	<script>
   	 		bidFileService.confirmBidFilePriceEffective(bidFileId);
   	 	</script>
    </scriptTask>
    <userTask id="usertask21" name="专家组长审核" activiti:assignee="${expertGroupService.getExpertGroupLeaderByExpertApplyId(execution.processBusinessKey).id}" activiti:formKey="clarification/bidfile_clarifi_approve">
    	<documentation>${projectInstanceName} ${projectItemName} ${tenderUserName} 投标报价澄清审核</documentation>
    	<extensionElements>
        	<activiti:formProperty id="projectItemId" name="标段ID" type="string" expression="${projectItemId}"></activiti:formProperty>
       	 	<activiti:formProperty id="bidFileId" name="投标报价ID" type="string" expression="${bidFileId}"></activiti:formProperty>
       	 	<activiti:formProperty id="tenderItemId" name="tenderItemId" type="string" expression="${tenderItemId}"></activiti:formProperty>
       	 	<activiti:formProperty id="clarifyResult" name="澄清审核结果" type="string" required="true"></activiti:formProperty>
      	</extensionElements>
    </userTask>
    <sequenceFlow id="flow249" sourceRef="usertask21" targetRef="exclusivegateway2"></sequenceFlow>
    <exclusiveGateway id="exclusivegateway2" name="Exclusive Gateway"></exclusiveGateway>
    <sequenceFlow id="flow250" sourceRef="exclusivegateway2" targetRef="usertask20">
    	<conditionExpression xsi:type="tFormalExpression"><![CDATA[${clarifyResult=='-1'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow251" sourceRef="exclusivegateway2" targetRef="usertask19">
    	<conditionExpression xsi:type="tFormalExpression"><![CDATA[${clarifyResult!='-1'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow252" sourceRef="scripttask2" targetRef="endevent21"></sequenceFlow>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_bid_file_price_clarify_flow">
    <bpmndi:BPMNPlane bpmnElement="bid_file_price_clarify_flow" id="BPMNPlane_bid_file_price_clarify_flow">
      <bpmndi:BPMNShape bpmnElement="usertask19" id="BPMNShape_usertask19">
        <omgdc:Bounds height="55.0" width="105.0" x="248.0" y="297.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="startevent11" id="BPMNShape_startevent11">
        <omgdc:Bounds height="35.0" width="35.0" x="124.0" y="40.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="scripttask1" id="BPMNShape_scripttask1">
        <omgdc:Bounds height="55.0" width="105.0" x="305.0" y="30.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="endevent21" id="BPMNShape_endevent21">
        <omgdc:Bounds height="35.0" width="35.0" x="110.0" y="205.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="usertask20" id="BPMNShape_usertask20">
        <omgdc:Bounds height="55.0" width="105.0" x="540.0" y="100.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="scripttask2" id="BPMNShape_scripttask2">
        <omgdc:Bounds height="55.0" width="105.0" x="248.0" y="195.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="usertask21" id="BPMNShape_usertask21">
        <omgdc:Bounds height="55.0" width="105.0" x="560.0" y="297.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="exclusivegateway2" id="BPMNShape_exclusivegateway2">
        <omgdc:Bounds height="40.0" width="40.0" x="460.0" y="243.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="flow238" id="BPMNEdge_flow238">
        <omgdi:waypoint x="159.0" y="57.0"></omgdi:waypoint>
        <omgdi:waypoint x="305.0" y="57.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow243" id="BPMNEdge_flow243">
        <omgdi:waypoint x="300.0" y="297.0"></omgdi:waypoint>
        <omgdi:waypoint x="300.0" y="250.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow244" id="BPMNEdge_flow244">
        <omgdi:waypoint x="357.0" y="85.0"></omgdi:waypoint>
        <omgdi:waypoint x="592.0" y="100.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow245" id="BPMNEdge_flow245">
        <omgdi:waypoint x="592.0" y="155.0"></omgdi:waypoint>
        <omgdi:waypoint x="612.0" y="297.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow249" id="BPMNEdge_flow249">
        <omgdi:waypoint x="612.0" y="297.0"></omgdi:waypoint>
        <omgdi:waypoint x="480.0" y="283.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow250" id="BPMNEdge_flow250">
        <omgdi:waypoint x="480.0" y="243.0"></omgdi:waypoint>
        <omgdi:waypoint x="592.0" y="155.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow251" id="BPMNEdge_flow251">
        <omgdi:waypoint x="480.0" y="283.0"></omgdi:waypoint>
        <omgdi:waypoint x="300.0" y="297.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow252" id="BPMNEdge_flow252">
        <omgdi:waypoint x="248.0" y="222.0"></omgdi:waypoint>
        <omgdi:waypoint x="145.0" y="222.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>